<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Overview ·  </title><link rel="canonical" href="https://MagneticParticleImaging.github.io/MNPDynamics.jl/overview/"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="  logo"/></a><div class="docs-package-name"><span class="docs-autofit"> </span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Overview</a><ul class="internal"><li><a class="tocitem" href="#Simple-Simulation-(No-Relaxation)"><span>Simple Simulation (No Relaxation)</span></a></li><li><a class="tocitem" href="#Neel-Relaxation"><span>Neel Relaxation</span></a></li><li><a class="tocitem" href="#Brown-Relaxation"><span>Brown Relaxation</span></a></li><li><a class="tocitem" href="#Multiple-Parameters"><span>Multiple Parameters</span></a></li></ul></li><li><a class="tocitem" href="../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Overview</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Overview</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/MagneticParticleImaging/MNPDynamics.jl/blob/master/docs/src/overview.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Overview"><a class="docs-heading-anchor" href="#Overview">Overview</a><a id="Overview-1"></a><a class="docs-heading-anchor-permalink" href="#Overview" title="Permalink"></a></h1><p>On this page we give an overview of MNPDynamics. </p><h2 id="Simple-Simulation-(No-Relaxation)"><a class="docs-heading-anchor" href="#Simple-Simulation-(No-Relaxation)">Simple Simulation (No Relaxation)</a><a id="Simple-Simulation-(No-Relaxation)-1"></a><a class="docs-heading-anchor-permalink" href="#Simple-Simulation-(No-Relaxation)" title="Permalink"></a></h2><p>We start with a very simple simulation. 20 nm particles are simulated without relaxation under sinusoidal excitation. We start by loading <code>MNPDynamics</code> and define the time interval. Here we use 1000 samples and an excitation frequency of 25 kHz:</p><pre><code class="language-julia">using MNPDynamics

# Time parameters
fx = 25000;
tLength = 1000;       # length of time vector
tMax = 1/fx;          # maximum evaluation time in seconds
t = range(0, stop=tMax, length=tLength);</code></pre><p>In the next step we define the applied magnetic field. This is done using by defining a  magnetic field function <code>B</code> that maps <code>t</code> to the magnetic flux density <code>B</code>:</p><pre><code class="language-julia"># Field parameters
amplitude = 0.012

# Magnetic field for simulation 
B(t) = amplitude*[cos(2*pi*fx*t), 0, 0]</code></pre><p>You can of course also define this as</p><pre><code class="language-julia">function B(t)
 return amplitude*[cos(2*pi*fx*t), 0, 0]
end</code></pre><p>or as an anonymous function:</p><pre><code class="language-julia">B = t -&gt; (amplitude*[cos(2*pi*fx*t), 0, 0])</code></pre><p>You also don&#39;t need to call it <code>B</code>.</p><p>In the next step we define additional simulation parameters in a dictionary <code>p</code> and pass <code>B</code>, <code>t</code> and <code>p</code> to the function <code>simulationMNP</code>:</p><pre><code class="language-julia"># Parameters
p = Dict{Symbol,Any}()
p[:DCore] = 20e-9                  # particle diameter in nm
p[:relaxation] = NO_RELAXATION     # relaxation mode

# Do simulation
m = simulationMNP(B, t; p...)</code></pre><p>What you get back is the mean magnetic moment of the particle. Often we measure this function inductively using a pick-up coil and then receive the time derivative of the mean magnetic moment. The following image shows the result of this simple simulation.</p><p><img src="../assets/simpleNoRelaxation.svg" alt="Simple 1D Simulation"/></p><h2 id="Neel-Relaxation"><a class="docs-heading-anchor" href="#Neel-Relaxation">Neel Relaxation</a><a id="Neel-Relaxation-1"></a><a class="docs-heading-anchor-permalink" href="#Neel-Relaxation" title="Permalink"></a></h2><p>We next repeat the simulation but change the parameter dictionary like this:</p><pre><code class="language-julia">p = Dict{Symbol,Any}()
p[:DCore] = 20e-9         # particle diameter in nm
p[:α] = 0.1               # damping coefficient
p[:kAnis] = 11000         # anisotropy constant
p[:N] = 20                # maximum spherical harmonics index to be considered
p[:n] = [1;0;0]           # anisotropy axis
p[:relaxation] = NEEL     # relaxation mode
p[:reltol] = 1e-6         # relative tolerance
p[:abstol] = 1e-6         # absolute tolerance
p[:tWarmup] = 0.00005     # warmup time. The simulation is started at -tWarmup</code></pre><p>The results in the following images show that the particle response now clearly lacks behind the excitation:</p><p><img src="../assets/neelRelaxation.svg" alt="1D Neel Relaxation"/></p><p>Next, we switch the excitation function to be rect function.</p><pre><code class="language-julia">Brect(t) = amplitude*[ 0.25 &lt; fx*mod(t,1) &lt; 0.75  ? -1.0 : 1.0 , 0, 0]</code></pre><p>We also use a more stable solver:</p><pre><code class="language-julia">p[:solver] = :Rodas5</code></pre><p>The simulation result looks like this:</p><p><img src="../assets/neelRelaxationRect.svg" alt="1D Neel Relaxation"/></p><p>One can nicely see the expected exponential decay after the field changes its sign.</p><h2 id="Brown-Relaxation"><a class="docs-heading-anchor" href="#Brown-Relaxation">Brown Relaxation</a><a id="Brown-Relaxation-1"></a><a class="docs-heading-anchor-permalink" href="#Brown-Relaxation" title="Permalink"></a></h2><p>It is also possible to simulate Brownian relaxation. This can be done with the  following parameter dictionary:</p><pre><code class="language-julia"># Parameters
p = Dict{Symbol,Any}()
p[:DCore] = 20e-9         # particle diameter in nm
p[:DHydro] = 80e-9        # particle diameter in nm
p[:η] = 1e-5              # viscosity
p[:N] = 20                # maximum spherical harmonics index to be considered
p[:relaxation] = BROWN    # relaxation mode</code></pre><p><img src="../assets/brownRelaxation.svg" alt="1D Brown Relaxation"/></p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Currently it is not possible to simulate Brownian and Neel relaxation simultaneously.</p></div></div><h2 id="Multiple-Parameters"><a class="docs-heading-anchor" href="#Multiple-Parameters">Multiple Parameters</a><a id="Multiple-Parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Multiple-Parameters" title="Permalink"></a></h2><p>Quite often, the goal is to to perform multiple simulations. Since this can get quite time intensive it can be benefitial to use parallel computation. To do this you need to start julia with <code>-p P</code> where P is the number of CPU cores that the computer has.</p><p>Our goal is to perform simulations with the same 2D excitation but for various different static offset fields. In the magnetic particle imaging (MPI) setting this is usually referred to as the system matrix. In particular we aim to reproduce Fig. 4 of <a href="https://iopscience.iop.org/article/10.1088/1367-2630/ab4938/pdf">this publication</a>.</p><p>We start by defining the general parameters:</p><pre><code class="language-julia">using MNPDynamics, FFTW

# Parameters
p = Dict{Symbol,Any}()
p[:DCore] = 20e-9         # particle diameter in nm
p[:α] = 0.1               # damping coefficient
p[:kAnis] = 1250          # anisotropy constant
p[:N] = 20                # maximum spherical harmonics index to be considered
p[:relaxation] = NEEL     # relaxation mode
p[:reltol] = 1e-4         # relative tolerance
p[:abstol] = 1e-6         # absolute tolerance
p[:tWarmup] = 0.00005     # warmup time
p[:derivative] = true
p[:solver] = :FBDF        # Use more stable solver

# Excitation frequencies
const fx = 2.5e6 / 102
const fy = 2.5e6 / 96

samplingRate = 2.5e6
tLength = lcm(96,102);             # length of time vector
tMax = lcm(96,102) / samplingRate; # maximum evaluation time in seconds
t = range(0, stop=tMax, length=tLength);</code></pre><p>Next we define a more general magnetic field function, which not only gets the time <code>t</code> but also the <code>offset</code>.</p><pre><code class="language-julia">const amplitude = 0.012
B(t, offset) = amplitude*[sin(2*pi*fx*t), sin(2*pi*fy*t), 0] .+ offset </code></pre><p>We then define the offset on a <span>$30 x 30$</span> grid. This can be done in Julia in a very terse syntax using <code>CartesianIndices</code>:</p><pre><code class="language-julia">nOffsets = (30, 30, 1)

oversampling = 1.25
offsets = vec([ oversampling*amplitude.*2.0.*((Tuple(x).-0.5)./nOffsets.-0.5)  
                for x in CartesianIndices(nOffsets) ])</code></pre><p>Basically, <code>offsets</code> is a vector of <code>Tuples</code> and the elements are passed to the callback function <code>B</code> we defined before.</p><p>In addition to the offsets we also want the anisotropy axis to be offset dependent (see publication). Therefore, we define the anisotropy axis on a grid as well: </p><pre><code class="language-julia">anisotropyAxis = vec([ oversampling*2.0.*((Tuple(x).-0.5)./nOffsets.-0.5) 
                       for x in CartesianIndices(nOffsets) ])
p[:kAnis] = p[:kAnis]*anisotropyAxis</code></pre><p>Finally we perform the simulation and apply a Fourier transform along the time axis:</p><pre><code class="language-julia">smM = simulationMNPMultiParams(B, t, offsets; p...)

smMFT = reshape(rfft(smM, 1), :, 3, nOffsets...)</code></pre><p>The resulting dataset looks like this:</p><p><img src="../assets/systemMatrix.svg" alt="2D System Matrix"/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../api/">API »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Tuesday 22 November 2022 16:23">Tuesday 22 November 2022</span>. Using Julia version 1.8.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
